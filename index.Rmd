---
title: "nycanalysis"
author: "Drazzel Feliu"
date: "4/19/2019"
output: html_document
---

```{r}
rm(list = ls())

library(tidyverse)
library(sf)
library(viridis)
library(leaflet)
library(maps)
library(htmlwidgets)
library(tidycensus)
library(htmltools)
library(tigris)

options(tigris_use_cache = TRUE)
```

```{r}
codebook <- load_variables(2017,"acs5")
```

```{r}
boroughboundaries <- get_acs(geography = "county",
        variables = "B19013_001",
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017)

nycdata <- get_acs(geography = "tract",
        variables = "B19013_001",
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017,
        cb = FALSE)
```

```{r}
st_erase <- function(x, y) {
  st_difference(x, st_union(st_combine(y)))
  }

mh_water <- area_water("NY", "New York", class = "sf")
bx_water <- area_water("NY", "Bronx", class = "sf")
bk_water <- area_water("NY", "Kings", class = "sf")
qu_water <- area_water("NY", "Queens", class = "sf")
si_water <- area_water("NY", "Richmond", class = "sf")

ny_water <- rbind(mh_water,bx_water,bk_water,qu_water,si_water)

nycdata2 <- st_erase(nycdata, ny_water)
```

```{r}
boroughboundaries <- st_erase(boroughboundaries, ny_water)
```


```{r}
nyccolor <- colorNumeric(
  palette = "magma",
  domain = nycdata2$estimate)
```

```{r}
housingdata <- read.csv("Housing_New_York_Units_by_Building.csv")
glimpse(housingdata)
```

```{r}
nycdatahighlights <- highlightOptions(
  weight = 4.5,
  color = "#ffffff",
  fillOpacity = .5,
  bringToFront = TRUE)

nycdatalabeloptions <- labelOptions(
  style = list("font-weight" = "normal", padding = "3px 8px"),
  textsize = "15px",
  direction = "auto")
```

```{r, results='hide'}
nycdatalabels <- sprintf(
  paste0(
  "<strong>Name: </strong>%s<br/>",
  "<strong>Median Income in 2017: </strong>%g"),
  nycdata2$NAME,
  nycdata2$estimate
  ) %>% 
  lapply(HTML)
```

```{r}
housingdatalabels <- sprintf(
  paste0(
  "<strong>Project Name: </strong>%s<br/>",
  "<strong>Address: </strong>%s<br/>",
  "<strong># of Available Extremely Low Income Units: </strong>%g<br/>",
  "<strong># of Available Very Low Income Units: </strong>%g<br/>",
  "<strong># of Available Low Income Units: </strong>%g<br/>",
  "<strong># of Available Moderate Income Units: </strong>%g<br/>",
  "<strong># of Available Middle Income Units: </strong>%g<br/>",
  "<strong># of Available Other Income Units: </strong>%g<br/>",
  "<strong># of Available Rental Units: </strong>%g<br/>"),
  housingdata$Project.Name,
  as.character(paste0(housingdata$Number,sep=" ",housingdata$Street)),
  housingdata$Extremely.Low.Income.Units,
  housingdata$Very.Low.Income.Units,
  housingdata$Low.Income.Units,
  housingdata$Moderate.Income.Units,
  housingdata$Middle.Income.Units,
  housingdata$Other.Income.Units,
  housingdata$Counted.Rental.Units
  ) %>% 
  lapply(HTML)
```

```{r}
housingcolor <- colorBin(
  palette = "viridis",
  domain = housingdata$Counted.Rental.Units,
  bins = c(0,50,100,150,200,1000),
  right = T)

getRadius <- function(housingdata) {
  sapply(housingdata$Counted.Rental.Units, function(Counted.Rental.Units) {
  if(Counted.Rental.Units >=200)  {
    10
  } else if(Counted.Rental.Units >= 100) {
    7.5
  } else {
    5
  }  })
}
```

```{r}
map <- leaflet() %>% setView(lng = -74.0060, lat = 40.7128, zoom = 11) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = st_geometry(boroughboundaries),
              fillColor = NULL,
              color = "blue",
              weight = 1,
              fillOpacity = .01,
              smoothFactor = .2
              ) %>% 
  addPolygons(data=st_geometry(nycdata2),
              fillColor = nyccolor(nycdata2$estimate),
              color = "magma",
              weight= .3,
              smoothFactor = .2,
              fillOpacity = .55,
              popup  = nycdatalabels,
              popupOptions = nycdatalabeloptions,
              group = "Income",
              highlightOptions = nycdatahighlights
  ) %>% 
  addLegend(title = "Median Income",
            pal = nyccolor,
            values = nycdata2$estimate,
            position = "topright",
            group="Income") %>% 
  addCircleMarkers(housingdata$Longitude, 
                   housingdata$Latitude,
                   color = housingcolor(housingdata$Counted.Rental.Units),
                   radius = getRadius(housingdata),
                   stroke = FALSE,
                   fillOpacity = .5,
                   label = housingdatalabels,
                   group = "Housing") %>% 
  addLegend(title = "Number of Units Available",
            pal = housingcolor,
            values = housingdata$Counted.Rental.Units,
            position = "topright",
            group = "Housing") %>% 
  addLayersControl(
    overlayGroups = c("Income", "Housing"),
    position = "bottomright")
```

```{r}
saveWidget(map,"index.html")
```

EVERYTHING BELOW THIS POINT IS EXPERIMENTAL TO ADD RACE TO THE MAP 

```{r}
rm(list=ls())

racevars <- codebook %>% filter(str_detect(label,"race")) %>% filter(str_detect(label,"Population of one"))

acsracevars <- as.list(racevars[2:7,1])

racedataindi <- get_acs(geography = "tract",
        variables = unlist(acsracevars),
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017,
        cb = FALSE)

# MAKE EACH RACE ITS OWN COLUMN/VARIABLE OTHERWISE IT WON'T WORK! SIMPLE

racedatatotal <- get_acs(geography = "tract",
        variables = as.character(racevars[1,1]),
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017,
        cb = FALSE)


racedatatotal$geometry <- NULL

racedata <- merge(racedataindi,racedatatotal,c("NAME","GEOID"))
racedat <- racedata %>% select(-variable.y) %>% mutate(percent=estimate.x/estimate.y)
racedat <- st_erase(racedat,ny_water)

racedatahighlights <- highlightOptions(
  weight = 4.5,
  color = "#ffffff",
  fillOpacity = .5,
  bringToFront = TRUE)

racedatalabeloptions <- labelOptions(
  style = list("font-weight" = "normal", padding = "3px 8px"),
  textsize = "15px",
  direction = "auto")
```

```{r}
racedatalabels <- sprintf(
  paste0(
  "<strong>Name:</strong>%s<br/>",
  "<strong>Race:</strong> %s - %g<br/>"),
  racedat$NAME,
  racedat$variable.x,
  racedat$percent) %>% lapply(HTML)
```  


```{r}
leaflet() %>% setView(lng = -74.0060, lat = 40.7128, zoom = 11) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = st_geometry(racedat),
              fillColor = NULL,
              color = "blue",
              weight = 1,
              fillOpacity = .01,
              smoothFactor = .2,
              popup  = racedatalabels,
              popupOptions = racedatalabeloptions,
              highlightOptions = racedatahighlights
              )
```

