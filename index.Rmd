---
title: "nycanalysis"
author: "Drazzel Feliu"
date: "4/19/2019"
output: html_document
---

```{r}
rm(list = ls())

library(tidyverse)
library(sf)
library(viridis)
library(leaflet)
library(maps)
library(htmlwidgets)
library(tidycensus)
library(htmltools)
library(tigris)

options(tigris_use_cache = TRUE)
```

```{r, eval=FALSE}
codebook <- load_variables(2017,"acs5")
```

```{r}
nycdata <- get_acs(geography = "tract",
        variables = "B19013_001",
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017)

nycdata2 <- nycdata <- get_acs(geography = "tract",
        variables = "B19013_001",
        state = "NY",
        county = c("New York","Kings","Queens","Bronx","Richmond"),
        geometry = T,
        year = 2017,
        cb = FALSE)
```

```{r}
st_erase <- function(x, y) {
  st_difference(x, st_union(st_combine(y)))
  }

mh_water <- area_water("NY", "New York", class = "sf")
bx_water <- area_water("NY", "Bronx", class = "sf")
bk_water <- area_water("NY", "Kings", class = "sf")
qu_water <- area_water("NY", "Queens", class = "sf")
si_water <- area_water("NY", "Richmond", class = "sf")

ny_water <- rbind(mh_water,bx_water,bk_water,qu_water,si_water)

nycdata2 <- st_erase(nycdata2, ny_water)
```


```{r}
nyccolor <- colorNumeric(
  palette = "magma",
  domain = nycdata2$estimate)
```

```{r}
housingdata <- read.csv("Housing_New_York_Units_by_Building.csv")
glimpse(housingdata)
```

```{r}
nycdatahighlights <- highlightOptions(
  weight = 4.5,
  color = "#ffffff",
  fillOpacity = .5,
  bringToFront = TRUE)

nycdatalabeloptions <- labelOptions(
  style = list("font-weight" = "normal", padding = "3px 8px"),
  textsize = "15px",
  direction = "auto")
```

```{r, results='hide'}
nycdatalabels <- sprintf(
  paste0(
  "<strong>Name: </strong>%s<br/>",
  "<strong>Median Income in 2017: </strong>%g"),
  nycdata2$NAME,
  nycdata2$estimate
  ) %>% 
  lapply(HTML)
```


```{r}
map <- leaflet() %>% setView(lng = -74.0060, lat = 40.7128, zoom = 11) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=st_geometry(nycdata2),
              fillColor = nyccolor(nycdata2$estimate),
              color = "magma",
              weight= .3,
              smoothFactor = .2,
              fillOpacity = .55,
              popup  = nycdatalabels,
              popupOptions = nycdatalabeloptions,
              group = "Income",
              highlightOptions = nycdatahighlights
              ) %>% 
  addCircleMarkers(housingdata$Longitude, 
             housingdata$Latitude, 
             radius = 7.5,
             stroke = FALSE,
             fillOpacity = .5,
             label = as.character(housingdata$All.Counted.Units),
             group = "Total Affordable Housing Units Available by Property",
             clusterOptions = markerClusterOptions()) %>% 
  addLegend(
            title = "Median Income",
            pal = nyccolor,
            values = nycdata2$estimate,
            position = "topright",
            group="Income") %>% 
  addLayersControl(
    overlayGroups = c("Income", "Housing Units"),
    position = "bottomright")
```

```{r}
saveWidget(map,"index.html")
```

